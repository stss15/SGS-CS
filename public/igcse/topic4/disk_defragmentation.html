<!DOCTYPE html>
<html lang="en-GB">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disk Defragmentation Simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Define File Colours */
        :root {
            --f1-bg: #ef4444;
            --f1-border: #991b1b;
            --f2-bg: #f97316;
            --f2-border: #9a3412;
            --f3-bg: #eab308;
            --f3-border: #854d0e;
            --f4-bg: #22c55e;
            --f4-border: #14532d;
            --f5-bg: #3b82f6;
            --f5-border: #1e3a8a;
            --f6-bg: #a855f7;
            --f6-border: #581c87;
            --empty-bg: #ffffff;
            --empty-border: #d1d5db;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .sector {
            aspect-ratio: 1;
            transition: all 0.6s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.75rem;
            border-radius: 4px;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.2);
        }

        /* File Styles */
        .file-1 {
            background-color: var(--f1-bg);
            border: 2px solid var(--f1-border);
            color: white;
        }

        .file-2 {
            background-color: var(--f2-bg);
            border: 2px solid var(--f2-border);
            color: white;
        }

        .file-3 {
            background-color: var(--f3-bg);
            border: 2px solid var(--f3-border);
            color: black;
        }

        .file-4 {
            background-color: var(--f4-bg);
            border: 2px solid var(--f4-border);
            color: white;
        }

        .file-5 {
            background-color: var(--f5-bg);
            border: 2px solid var(--f5-border);
            color: white;
        }

        .file-6 {
            background-color: var(--f6-bg);
            border: 2px solid var(--f6-border);
            color: white;
        }

        .empty {
            background-color: var(--empty-bg);
            border: 1px solid var(--empty-border);
            color: #9ca3af;
        }

        .track-container {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 4px;
        }
    </style>
</head>

<body class="flex flex-col items-center h-screen overflow-hidden bg-slate-50 p-4">

    <div class="w-full max-w-6xl h-full flex flex-col">

        <!-- Header -->
        <div class="flex justify-between items-center mb-4 shrink-0">
            <div class="flex items-center gap-4">
                <a href="teacher_toolkit.html"
                    class="flex items-center justify-center w-10 h-10 rounded-full bg-white text-slate-600 shadow-sm hover:text-blue-600 hover:shadow-md transition border border-slate-200">
                    <i class="fa-solid fa-arrow-left"></i>
                </a>
                <div>
                    <h1 class="text-2xl font-bold text-slate-800">Disk <span class="keyword" data-def="a process that reorganises sectors on an HDD by rearranging blocks of data so that they are contiguous">Defragmentation</span></h1>
                    <p class="text-slate-500 text-xs hidden sm:block">Visualising file storage & optimisation.</p>
                </div>
            </div>

            <div class="flex gap-2 text-xs font-medium">
                <div class="flex items-center gap-1">
                    <div class="w-3 h-3 bg-red-500 rounded"></div> <span class="hidden sm:inline">File 1</span>
                </div>
                <div class="flex items-center gap-1">
                    <div class="w-3 h-3 bg-orange-500 rounded"></div> <span class="hidden sm:inline">File 2</span>
                </div>
                <div class="flex items-center gap-1">
                    <div class="w-3 h-3 bg-yellow-500 rounded"></div> <span class="hidden sm:inline">File 3</span>
                </div>
                <div class="flex items-center gap-1">
                    <div class="w-3 h-3 bg-green-500 rounded"></div> <span class="hidden sm:inline">File 4</span>
                </div>
                <div class="flex items-center gap-1">
                    <div class="w-3 h-3 bg-blue-500 rounded"></div> <span class="hidden sm:inline">File 5</span>
                </div>
                <div class="flex items-center gap-1">
                    <div class="w-3 h-3 bg-purple-500 rounded"></div> <span class="hidden sm:inline">File 6</span>
                </div>
            </div>
        </div>

        <!-- Simulation Viewport -->
        <div class="bg-white rounded-xl shadow-lg border border-slate-200 flex-1 min-h-0 flex flex-col overflow-hidden">

            <!-- Tracks (Scrollable if needed) -->
            <div class="flex-1 overflow-y-auto p-6 space-y-4">
                <!-- Track 1 -->
                <div>
                    <div
                        class="flex justify-between text-xs text-slate-500 font-semibold uppercase tracking-wider mb-1">
                        <span>Track 1 (Sectors 0-11)</span>
                    </div>
                    <div id="track-0" class="track-container bg-slate-100 p-2 rounded-lg border border-slate-200"></div>
                </div>

                <!-- Track 2 -->
                <div>
                    <div
                        class="flex justify-between text-xs text-slate-500 font-semibold uppercase tracking-wider mb-1">
                        <span>Track 2 (Sectors 12-23)</span>
                    </div>
                    <div id="track-1" class="track-container bg-slate-100 p-2 rounded-lg border border-slate-200"></div>
                </div>

                <!-- Track 3 -->
                <div>
                    <div
                        class="flex justify-between text-xs text-slate-500 font-semibold uppercase tracking-wider mb-1">
                        <span>Track 3 (Sectors 24-35)</span>
                    </div>
                    <div id="track-2" class="track-container bg-slate-100 p-2 rounded-lg border border-slate-200"></div>
                </div>
            </div>

            <!-- RAM Buffer (Fixed at bottom of viewport) -->
            <div class="shrink-0 border-t-2 border-dashed border-slate-200 p-4 bg-slate-50">
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-xs font-bold text-slate-600 uppercase tracking-wide">RAM <span class="keyword" data-def="a memory area used to store data temporarily">Buffer</span></span>
                </div>
                <div id="buffer"
                    class="flex gap-2 p-3 bg-white rounded-lg border border-slate-200 min-h-[60px] overflow-x-auto items-center shadow-inner">
                    <span class="text-slate-400 text-xs italic w-full text-center"><span class="keyword" data-def="a memory area used to store data temporarily">Buffer</span> Empty</span>
                </div>
            </div>

        </div>

        <!-- Controls & Explanation -->
        <div
            class="mt-4 bg-slate-800 text-white rounded-xl p-4 shadow-xl flex flex-col md:flex-row gap-4 items-center shrink-0">

            <div class="flex-1 w-full">
                <div class="flex items-center gap-3 mb-1">
                    <span class="bg-blue-600 text-[10px] font-bold px-2 py-0.5 rounded uppercase" id="step-tag">Step
                        1</span>
                    <h2 class="text-lg font-bold" id="step-title">Initial State</h2>
                </div>
                <p class="text-slate-300 text-sm leading-snug" id="step-desc">
                    We start with an empty hard disk drive (HDD). The read/write head is ready at Track 1.
                </p>
            </div>

            <div
                class="flex items-center gap-3 shrink-0 w-full md:w-auto justify-between md:justify-end border-t md:border-t-0 border-slate-700 pt-3 md:pt-0 mt-2 md:mt-0">
                <button onclick="changeStep(-1)" id="btn-prev" disabled
                    class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-medium text-sm transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                    ← Prev
                </button>
                <div class="text-center min-w-[50px] font-mono font-bold text-slate-400 text-sm" id="step-counter">1 / 9
                </div>
                <button onclick="changeStep(1)" id="btn-next"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold text-sm shadow-lg transition flex items-center gap-2">
                    Next →
                </button>
            </div>
        </div>

    </div>

    <script>
        // --- Simulation State Management ---

        let diskState = Array(3).fill().map(() => Array(12).fill(0));
        let bufferState = [];
        let defragCursor = 0; // Tracks where the next contiguous file should start (linear index 0-35)

        // Helper to convert linear index to [track, sector]
        function getPos(linearIdx) {
            return { t: Math.floor(linearIdx / 12), s: linearIdx % 12 };
        }

        // Helper to move conflicting blocks to end of disk
        function moveConflict(targetT, targetS) {
            const conflictId = diskState[targetT][targetS];
            if (conflictId === 0) return; // No conflict

            // Find free space at END of disk working backwards or forwards
            // Simple approach: Find first empty spot starting from end of Track 3
            let freeT = -1, freeS = -1;

            // Search for free space
            for (let t = 2; t >= 0; t--) {
                for (let s = 11; s >= 0; s--) {
                    if (diskState[t][s] === 0) {
                        freeT = t; freeS = s;
                        break; // found one
                    }
                }
                if (freeT !== -1) break;
            }

            if (freeT !== -1) {
                diskState[freeT][freeS] = conflictId; // Move conflict there
                diskState[targetT][targetS] = 0;      // Clear original spot
            }
        }

        function defragOneFile(fileId, fileLength) {
            // 1. Identify and clear current blocks of fileId
            let count = 0;
            for (let t = 0; t < 3; t++) {
                for (let s = 0; s < 12; s++) {
                    if (diskState[t][s] === fileId) {
                        diskState[t][s] = 0; // Pick it up
                        count++;
                    }
                }
            }

            // 2. Put in Buffer (Visual only)
            bufferState = Array(count).fill(fileId);
            render(); // Trigger visual update of buffer before writing back (simulated delay via logic split?)
            // For simplicity in this discrete step engine, we update buffer state but the write happens immediately in logic
            // To make it feel like "Move out, then Move In", we rely on the timeline description, or we could split steps.

            // 3. Write back contiguously starting at defragCursor
            for (let i = 0; i < fileLength; i++) {
                const pos = getPos(defragCursor + i);

                // CHECK COLLISION: Is there something else here?
                if (diskState[pos.t][pos.s] !== 0 && diskState[pos.t][pos.s] !== fileId) {
                    // Move the obstacle to free space
                    moveConflict(pos.t, pos.s);
                }

                diskState[pos.t][pos.s] = fileId;
            }

            // Advance cursor
            defragCursor += fileLength;
        }

        // Simulation Timeline
        const timeline = [
            {
                tag: "Initialisation",
                title: "Empty Disk",
                desc: "The disk is formatted and empty. All sectors are available for data storage.",
                action: () => {
                    resetDisk();
                    defragCursor = 0;
                }
            },
            {
                tag: "Usage",
                title: "Files Saved Contiguously",
                desc: "Files 1, 2, and 3 are saved. They sit perfectly next to each other.",
                action: () => {
                    resetDisk();
                    addFile(1, 4); addFile(2, 5); addFile(3, 4);
                }
            },
            {
                tag: "Usage",
                title: "Delete File 2",
                desc: "File 2 (Orange) is deleted, leaving a gap.",
                action: () => {
                    removeFile(2);
                }
            },
            {
                tag: "Usage",
                title: "Fragmenting File 4",
                desc: "File 4 (Green) is saved. It's too big for the gap, so it splits between the gap and the next available space.",
                action: () => {
                    resetDisk(); addFile(1, 4); addFile(3, 4);
                    addFile(4, 6);
                }
            },
            {
                tag: "Heavy Usage",
                title: "Messy Disk State",
                desc: "After much use (deleting F1, adding F5, F6), the disk is a mess. Notice how File 5 (Blue) blocks the start of the disk, and File 3 is scattered.",
                action: () => {
                    // Hardcoded messy state
                    // F1 deleted. 
                    // Track 1: F5(3 blocks), F6(1), F4(5), F3(3)
                    // Track 2: F3(1), F4(1), F5(5)...
                    diskState = [
                        [5, 5, 5, 6, 4, 4, 4, 4, 4, 3, 3, 3],
                        [3, 4, 5, 5, 5, 5, 5, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                    ];
                    bufferState = [];
                    defragCursor = 0; // Reset for defrag start
                }
            },
            // DEFRAG STEPS
            {
                tag: "Defrag: File 3",
                title: "Processing File 3 (Yellow)",
                desc: "The OS wants to put File 3 first. But File 5 (Blue) is in the way! The OS moves the Blue blocks to the end of the disk to make space, then writes File 3 at the start.",
                action: () => {
                    // Reset to messy state first to ensure consistency if rewinding
                    diskState = [
                        [5, 5, 5, 6, 4, 4, 4, 4, 4, 3, 3, 3],
                        [3, 4, 5, 5, 5, 5, 5, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                    ];
                    defragCursor = 0;

                    defragOneFile(3, 4); // Length 4
                }
            },
            {
                tag: "Defrag: File 4",
                title: "Processing File 4 (Green)",
                desc: "File 3 is safe. Now the OS grabs scattered chunks of File 4. It places them immediately after File 3. If anything blocks the way, it gets moved to the end.",
                action: () => {
                    // Re-run previous steps to ensure state
                    diskState = [
                        [5, 5, 5, 6, 4, 4, 4, 4, 4, 3, 3, 3],
                        [3, 4, 5, 5, 5, 5, 5, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                    ];
                    defragCursor = 0;
                    defragOneFile(3, 4); // Do prev
                    defragOneFile(4, 6); // Do current
                }
            },
            {
                tag: "Defrag: File 5",
                title: "Processing File 5 (Blue)",
                desc: "File 5 was moved around earlier to make space. Now it is gathered up and placed neatly after File 4.",
                action: () => {
                    diskState = [
                        [5, 5, 5, 6, 4, 4, 4, 4, 4, 3, 3, 3],
                        [3, 4, 5, 5, 5, 5, 5, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                    ];
                    defragCursor = 0;
                    defragOneFile(3, 4);
                    defragOneFile(4, 6);
                    defragOneFile(5, 8); // Length 8
                }
            },
            {
                tag: "Defrag: File 6",
                title: "Processing File 6 (Purple)",
                desc: "Finally, the tiny File 6 is moved into place. The disk is now perfectly ordered, and all free space is at the end.",
                action: () => {
                    diskState = [
                        [5, 5, 5, 6, 4, 4, 4, 4, 4, 3, 3, 3],
                        [3, 4, 5, 5, 5, 5, 5, 0, 0, 0, 0, 0],
                        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                    ];
                    defragCursor = 0;
                    defragOneFile(3, 4);
                    defragOneFile(4, 6);
                    defragOneFile(5, 8);
                    defragOneFile(6, 1); // Length 1
                    bufferState = []; // Clear buffer at end
                }
            }
        ];

        // --- Helpers ---

        function resetDisk() {
            diskState = Array(3).fill().map(() => Array(12).fill(0));
            bufferState = [];
        }

        function addFile(id, length) {
            let remaining = length;
            for (let t = 0; t < 3; t++) {
                for (let s = 0; s < 12; s++) {
                    if (diskState[t][s] === 0 && remaining > 0) {
                        diskState[t][s] = id;
                        remaining--;
                    }
                }
            }
        }

        function removeFile(id) {
            for (let t = 0; t < 3; t++) {
                for (let s = 0; s < 12; s++) {
                    if (diskState[t][s] === id) diskState[t][s] = 0;
                }
            }
        }

        // --- Rendering ---
        let currentStepIndex = 0;

        function render() {
            for (let t = 0; t < 3; t++) {
                const trackEl = document.getElementById(`track-${t}`);
                trackEl.innerHTML = '';
                diskState[t].forEach((cellVal, idx) => {
                    const div = document.createElement('div');
                    div.className = `sector ${cellVal === 0 ? 'empty' : 'file-' + cellVal}`;
                    div.innerText = cellVal === 0 ? idx : `F${cellVal}`;
                    // Wave animation delay
                    // div.style.animationDelay = `${(t * 12 + idx) * 10}ms`;
                    trackEl.appendChild(div);
                });
            }

            const bufferEl = document.getElementById('buffer');
            bufferEl.innerHTML = '';
            if (bufferState.length === 0) {
                bufferEl.innerHTML = '<span class="text-slate-400 text-sm italic w-full text-center">Buffer Empty</span>';
            } else {
                bufferState.forEach(cellVal => {
                    const div = document.createElement('div');
                    div.className = `sector file-${cellVal} w-10 h-10 shrink-0`;
                    div.innerText = `F${cellVal}`;
                    bufferEl.appendChild(div);
                });
            }

            const step = timeline[currentStepIndex];
            document.getElementById('step-tag').innerText = step.tag;
            document.getElementById('step-title').innerText = step.title;
            document.getElementById('step-desc').innerText = step.desc;
            document.getElementById('step-counter').innerText = `${currentStepIndex + 1} / ${timeline.length}`;

            document.getElementById('btn-prev').disabled = currentStepIndex === 0;
            const nextBtn = document.getElementById('btn-next');
            if (currentStepIndex === timeline.length - 1) {
                nextBtn.innerText = "Simulation Complete";
                nextBtn.disabled = true;
                nextBtn.classList.add('bg-slate-400');
                nextBtn.classList.remove('bg-blue-600', 'hover:bg-blue-500');
            } else {
                nextBtn.innerText = "Next Action →";
                nextBtn.disabled = false;
                nextBtn.classList.add('bg-blue-600', 'hover:bg-blue-500');
                nextBtn.classList.remove('bg-slate-400');
            }
        }

        function changeStep(delta) {
            const newIndex = currentStepIndex + delta;
            if (newIndex >= 0 && newIndex < timeline.length) {
                currentStepIndex = newIndex;
                timeline[currentStepIndex].action();
                render();
            }
        }

        timeline[0].action();
        render();

    </script>
</body>

</html>