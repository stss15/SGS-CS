<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topic 2 End of Unit Assessment | St George's CS</title>
    <!-- version: retryable-assessment v4 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --sg-blue: #003366;
            --sg-gold: #D4AF37;
            --sg-text: #333333;
            --sg-light-blue: #e6f0fa;
            --sg-grey: #f4f6f8;
            --correct-green: #28a745;
            --wrong-red: #dc3545;
            --paired-amber: #f0ad4e;
            --reflection-green: #28a745;
            --teacher-purple: #6f42c1;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            color: var(--sg-text);
            background-color: #ffffff;
            line-height: 1.6;
            padding-bottom: 100px;
        }

        /* Start Modal */
        #startOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 51, 102, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        #startCard {
            background: white;
            padding: 40px;
            border-radius: 16px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            border-top: 6px solid var(--sg-gold);
        }

        #startCard h2 {
            color: var(--sg-blue);
            margin-bottom: 8px;
            font-size: 1.8rem;
        }

        #startCard .test-name {
            color: var(--sg-gold);
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 20px;
        }

        #startCard .instructions {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        #startCard label {
            font-size: 0.9rem;
            color: #555;
            display: block;
            text-align: left;
            margin-bottom: 6px;
            font-weight: 600;
        }

        #startCard select {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            background: white;
        }

        #startCard select:focus {
            border-color: var(--sg-blue);
            outline: none;
        }

        #startCard button {
            width: 100%;
            padding: 14px;
            background: var(--sg-blue);
            color: white;
            border: none;
            border-radius: 30px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        #startCard button:hover {
            background: var(--sg-gold);
            transform: translateY(-2px);
        }

        /* Timer Display */
        #timerDisplay {
            position: fixed;
            top: 18px;
            right: 100px;
            color: var(--sg-blue);
            font-size: 1rem;
            font-weight: 600;
            z-index: 900;
            background: white;
            padding: 8px 16px;
            border-radius: 20px;
            border: 2px solid var(--sg-blue);
        }

        /* Header */
        header {
            background: white;
            padding: 1.5rem;
            border-bottom: 4px solid var(--sg-gold);
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        h1 {
            color: var(--sg-blue);
            margin-bottom: 0.5rem;
        }

        p.subtitle {
            color: #666;
            font-size: 0.9rem;
        }

        /* Main Content */
        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .question-block {
            background: var(--sg-grey);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 40px;
            border-left: 5px solid var(--sg-blue);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .q-header {
            font-weight: 700;
            color: var(--sg-blue);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .q-status {
            font-size: 0.8rem;
            padding: 4px 12px;
            border-radius: 20px;
            background: #ddd;
            color: #666;
        }

        .q-status.correct {
            background: var(--correct-green);
            color: white;
        }

        .q-status.wrong {
            background: var(--wrong-red);
            color: white;
        }

        /* Drag & Drop Styles */
        .bucket-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .bucket {
            flex: 1;
            background: white;
            border: 2px dashed #ccc;
            border-radius: 8px;
            min-height: 200px;
            padding: 15px;
            position: relative;
        }

        .bucket h4 {
            text-align: center;
            color: var(--sg-blue);
            margin-bottom: 10px;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .draggable-source {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border: 1px solid #eee;
            border-radius: 8px;
            min-height: 60px;
        }

        .drag-item {
            background: var(--sg-blue);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: grab;
            user-select: none;
            transition: transform 0.1s;
        }

        .drag-item:active {
            cursor: grabbing;
            transform: scale(1.05);
        }

        .drag-item.locked {
            background: var(--correct-green);
            cursor: default;
        }

        /* Dropdown Styles */
        .cloze-text {
            line-height: 2.2;
            font-size: 1.05rem;
        }

        select {
            padding: 5px 10px;
            border: 2px solid var(--sg-blue);
            border-radius: 5px;
            background: white;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            margin: 0 5px;
            font-size: 0.95rem;
        }

        select.correct {
            border-color: var(--correct-green);
            background: #e8f5e9;
            color: var(--correct-green);
            pointer-events: none;
        }

        select.wrong {
            border-color: var(--wrong-red);
            background: #f8d7da;
        }

        /* Ordering Lists */
        .order-list {
            list-style: none;
            padding: 0;
        }

        .order-item {
            background: white;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .order-num {
            font-weight: bold;
            color: var(--sg-gold);
        }

        /* Sortable List */
        .sortable-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sortable-item {
            background: white;
            border: 1px solid #ccc;
            border-left: 4px solid var(--sg-gold);
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 600;
            color: var(--sg-text);
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s;
        }

        .sortable-item:active {
            cursor: grabbing;
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .sortable-item i {
            color: #ccc;
        }

        .sortable-list.correct .sortable-item {
            border-color: var(--correct-green);
            border-left-color: var(--correct-green);
            background-color: #e8f5e9;
            cursor: default;
        }

        .sortable-list.wrong .sortable-item {
            border-left-color: var(--wrong-red);
            background-color: #fff5f5;
        }

        /* Matching Pairs */
        .match-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            align-items: start;
        }

        .col-defs,
        .col-terms {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .match-term,
        .match-def {
            background: white;
            padding: 15px;
            border: 2px solid #ccc;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .match-term:hover,
        .match-def:hover {
            border-color: var(--sg-gold);
            background: var(--sg-light-blue);
        }

        .match-selected {
            background: var(--sg-blue) !important;
            color: white !important;
            border-color: var(--sg-blue) !important;
        }

        .match-paired {
            background: #fff3cd !important;
            border-color: var(--paired-amber) !important;
            color: #856404 !important;
        }

        .match-solved {
            background: var(--correct-green) !important;
            color: white !important;
            border-color: var(--correct-green) !important;
            opacity: 0.8;
            pointer-events: none;
        }

        /* Footer Controls */
        .controls {
            text-align: center;
            margin-top: 40px;
        }

        .btn-submit {
            background: var(--sg-blue);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2rem;
            font-weight: 700;
            border-radius: 30px;
            cursor: pointer;
            transition: background 0.3s;
            box-shadow: 0 4px 15px rgba(0, 51, 102, 0.2);
        }

        .btn-submit:hover {
            background: var(--sg-gold);
            transform: translateY(-2px);
        }

        #finalScore {
            margin-top: 20px;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--sg-blue);
            display: none;
        }

        /* Back Button */
        #back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            font-size: 1.5rem;
            color: var(--sg-blue);
            text-decoration: none;
            transition: color 0.3s;
        }

        #back-btn:hover {
            color: var(--sg-gold);
        }

        /* Logo */
        #sg-logo {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 80px;
            z-index: 1000;
        }

        .btn-return {
            background: var(--sg-grey);
            color: var(--sg-text);
            border: 2px solid #ccc;
            padding: 15px 40px;
            font-size: 1.2rem;
            font-weight: 700;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: none;
            margin-left: 10px;
        }

        .btn-return:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }

        /* Completion Message */
        .completion-message {
            display: none;
            background: linear-gradient(135deg, var(--correct-green), #20c997);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-top: 20px;
        }

        .completion-message h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .completion-message p {
            font-size: 1rem;
            opacity: 0.9;
        }
    </style>
</head>

<body>
    <!-- Start Modal -->
    <div id="startOverlay">
        <div id="startCard">
            <h2>Assessment</h2>
            <div class="test-name">Topic 2: Data Transmission</div>
            <p class="instructions">
                Answer all questions by selecting from dropdowns, dragging items, or matching pairs.
                You must get all answers correct to complete the assessment.
                Your attempts are tracked and a feedback PDF will be generated upon completion.
            </p>
            <label for="teacherSelect">Select Your Teacher</label>
            <select id="teacherSelect">
                <option value="" disabled selected>Choose teacher...</option>
                <option value="Mr Stewart">Mr Stewart</option>
                <option value="Mr Watling">Mr Watling</option>
            </select>
            <button onclick="startAssessment()">Start Assessment</button>
        </div>
    </div>

    <div id="timerDisplay" style="display:none;"><i class="fa-solid fa-clock"></i> <span id="timer">00:00</span></div>

    <!-- Back Button -->
    <a href="assessments.html" id="back-btn" title="Back to Topic 2 Assessments"><i
            class="fa-solid fa-circle-arrow-left"></i></a>

    <!-- Logo -->
    <img src="../../images/Logo.png" id="sg-logo" alt="Logo">

    <header>
        <h1>Topic 2 Assessment</h1>
        <p class="subtitle">Data Transmission, Error Checking, and Encryption</p>
    </header>

    <main style="display:none;">

        <!-- Q1: Data Transmission Terminology (Matching) -->
        <div class="question-block" id="q1-block" data-summary="Match transmission terms">
            <div class="q-header">
                <span>Q1. Data Transmission Terminology</span>
                <span class="q-status" id="q1-status">Unanswered</span>
            </div>
            <p>Click a definition on the left, then the matching term on the right. Matched pairs will turn <span
                    style="color: #f0ad4e; font-weight: bold;">amber</span>.</p>

            <div class="match-grid">
                <div class="col-defs" id="col-defs">
                    <!-- Shuffled by JS -->
                </div>
                <div class="col-terms" id="col-terms">
                    <!-- Shuffled by JS -->
                </div>
            </div>
        </div>

        <!-- Q2: Packet Switching (Ordering) -->
        <div class="question-block" id="q2-block" data-summary="Packet switching process">
            <div class="q-header">
                <span>Q2. Packet Switching Process</span>
                <span class="q-status" id="q2-status">Unanswered</span>
            </div>
            <p>Order the steps in the packet switching process.</p>
            <div class="order-list">
                <div class="order-item"><span class="order-num">1.</span> <select id="q2a"
                        data-answer="Data is broken down into packets"></select></div>
                <div class="order-item"><span class="order-num">2.</span> <select id="q2b"
                        data-answer="Each packet is given a header with IP addresses and sequence number"></select>
                </div>
                <div class="order-item"><span class="order-num">3.</span> <select id="q2c"
                        data-answer="Packets are sent independently via different routes"></select></div>
                <div class="order-item"><span class="order-num">4.</span> <select id="q2d"
                        data-answer="Routers control the path of each packet"></select></div>
                <div class="order-item"><span class="order-num">5.</span> <select id="q2e"
                        data-answer="Packets arrive at the destination and are reordered"></select></div>
                <div class="order-item"><span class="order-num">6.</span> <select id="q2f"
                        data-answer="Corrupt or missing packets are requested again"></select></div>
            </div>
        </div>

        <!-- Q3: USB Features (True/False Drag) -->
        <div class="question-block" id="q3-block" data-summary="USB features">
            <div class="q-header">
                <span>Q3. USB Features</span>
                <span class="q-status" id="q3-status">Unanswered</span>
            </div>
            <p>Drag the statements into the correct category (True or False).</p>
            <div class="draggable-source" id="q3-source" ondrop="drop(event)" ondragover="allowDrop(event)">
                <!-- Items will be shuffled by JS -->
            </div>
            <div class="bucket-container">
                <div class="bucket" id="bucket-true" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <h4>True Statements</h4>
                </div>
                <div class="bucket" id="bucket-false" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <h4>False Statements</h4>
                </div>
            </div>
        </div>

        <!-- Q4: Error Checking (Categorisation) -->
        <div class="question-block" id="q4-block" data-summary="Error checking methods">
            <div class="q-header">
                <span>Q4. Error Checking Methods</span>
                <span class="q-status" id="q4-status">Unanswered</span>
            </div>
            <p>Drag the items into the correct category.</p>
            <div class="draggable-source" id="q4-source" ondrop="drop(event)" ondragover="allowDrop(event)">
                <!-- Items will be shuffled by JS -->
            </div>
            <div class="bucket-container">
                <div class="bucket" id="bucket-parity" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <h4>Parity Check</h4>
                </div>
                <div class="bucket" id="bucket-checksum" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <h4>Checksum</h4>
                </div>
                <div class="bucket" id="bucket-checkdigit" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <h4>Check Digit</h4>
                </div>
            </div>
        </div>

        <!-- Q5: Encryption (Dropdown Gap Fill) -->
        <div class="question-block" id="q5-block" data-summary="Encryption types">
            <div class="q-header">
                <span>Q5. Encryption</span>
                <span class="q-status" id="q5-status">Unanswered</span>
            </div>
            <div class="cloze-text">
                <select id="q5a" data-answer="Symmetric"></select> encryption uses a single key.<br>
                <select id="q5b" data-answer="Asymmetric"></select> encryption uses a public and private key.<br>
                The <select id="q5c" data-answer="Public"></select> key is shared with everyone.<br>
                The <select id="q5d" data-answer="Private"></select> key is kept secret.<br>
                <select id="q5e" data-answer="Plaintext"></select> is the original message.<br>
                <select id="q5f" data-answer="Ciphertext"></select> is the encrypted message.
            </div>
        </div>

        <!-- Q6: Error Detection Scenarios (Dropdown) -->
        <div class="question-block" id="q6-block" data-summary="Error detection scenarios">
            <div class="q-header">
                <span>Q6. Error Detection Scenarios</span>
                <span class="q-status" id="q6-status">Unanswered</span>
            </div>
            <div class="cloze-text">
                A barcode scanner beeps to indicate an error. This is likely a <select id="q6a"
                    data-answer="Check Digit"></select> error.<br>
                A file download fails because the calculated value doesn't match. This is a <select id="q6b"
                    data-answer="Checksum"></select> error.<br>
                A single bit flips during transmission. A <select id="q6c" data-answer="Parity Check"></select> might
                detect this.<br>
                Data is sent back to the sender to check. This is an <select id="q6d"
                    data-answer="Echo Check"></select>.
            </div>
        </div>

        <div class="controls">
            <button class="btn-submit" id="btnSubmit" onclick="checkAnswers()">Submit Answers</button>
            <a href="assessments.html" class="btn-return" id="btnReturn">Return to Menu</a>
            <div id="finalScore"></div>
            <div class="completion-message" id="completionMessage">
                <h3><i class="fa-solid fa-trophy"></i> Assessment Complete!</h3>
                <p>Your feedback PDF is downloading...</p>
            </div>
        </div>

    </main>

    <script>
        // --- SESSION / TRACKING ---
        let startTime;
        let timerInterval;
        let timeTakenStr = "";
        let teacherName = "";
        const testName = "Topic 2 End of Unit Assessment";

        // Attempt tracking
        const mistakeCounts = { q1: 0, q2: 0, q3: 0, q4: 0, q5: 0, q6: 0 };
        const completed = { q1: false, q2: false, q3: false, q4: false, q5: false, q6: false };
        let totalAttempts = 0;
        let assessmentFinished = false;

        // --- DATA FOR QUESTIONS ---

        // Q1 Data
        const q1Defs = [
            { id: '1', text: 'Data flows in one direction only' },
            { id: '2', text: 'Data flows in both directions, but not at the same time' },
            { id: '3', text: 'Data flows in both directions simultaneously' },
            { id: '4', text: 'Data is sent one bit at a time over a single wire' },
            { id: '5', text: 'Data is sent multiple bits at a time over multiple wires' }
        ];

        const q1Terms = [
            { id: '1', text: 'Simplex' },
            { id: '2', text: 'Half-Duplex' },
            { id: '3', text: 'Full-Duplex' },
            { id: '4', text: 'Serial' },
            { id: '5', text: 'Parallel' }
        ];

        // Q3 Data
        const q3Items = [
            { id: 't1', text: 'It is an industry standard', correct: 'true' },
            { id: 't2', text: 'Devices are automatically detected (plug and play)', correct: 'true' },
            { id: 't3', text: 'Connectors fit only one way', correct: 'true' },
            { id: 't4', text: 'Can power devices as well as transmit data', correct: 'true' },
            { id: 'f1', text: 'It uses parallel data transmission', correct: 'false' },
            { id: 'f2', text: 'It is only used for printers', correct: 'false' },
            { id: 'f3', text: 'It allows data to travel faster than fibre optic cables', correct: 'false' }
        ];

        // Q4 Data
        const q4Items = [
            { id: 'p1', text: 'Uses an extra bit to make 1s even or odd', correct: 'parity' },
            { id: 'p2', text: 'Can be horizontal and vertical', correct: 'parity' },
            { id: 'c1', text: 'Calculated value sent at end of data block', correct: 'checksum' },
            { id: 'c2', text: 'Uses an algorithm agreed by sender and receiver', correct: 'checksum' },
            { id: 'd1', text: 'Final digit calculated from other digits', correct: 'checkdigit' },
            { id: 'd2', text: 'Used for ISBNs and barcodes', correct: 'checkdigit' }
        ];

        // Dropdown Options
        const dropdownOptions = {
            q2: ['Data is broken down into packets', 'Each packet is given a header with IP addresses and sequence number', 'Packets are sent independently via different routes', 'Routers control the path of each packet', 'Packets arrive at the destination and are reordered', 'Corrupt or missing packets are requested again'],
            q5a: ['Symmetric', 'Asymmetric', 'Hashing'],
            q5b: ['Asymmetric', 'Symmetric', 'Hashing'],
            q5c: ['Public', 'Private', 'Secret'],
            q5d: ['Private', 'Public', 'Shared'],
            q5e: ['Plaintext', 'Ciphertext', 'Rawtext'],
            q5f: ['Ciphertext', 'Plaintext', 'Codedtext'],
            q6a: ['Check Digit', 'Parity Check', 'Checksum'],
            q6b: ['Checksum', 'Parity Check', 'Echo Check'],
            q6c: ['Parity Check', 'Checksum', 'Check Digit'],
            q6d: ['Echo Check', 'ARQ', 'Parity Check']
        };

        // Question Metadata
        const questionMeta = [
            { id: 'q1', title: 'Transmission Terminology', type: 'match', correctAnswer: { '1': 'Simplex', '2': 'Half-Duplex', '3': 'Full-Duplex', '4': 'Serial', '5': 'Parallel' } },
            { id: 'q2', title: 'Packet Switching', type: 'order', correctAnswer: ['Data is broken down into packets', 'Each packet is given a header with IP addresses and sequence number', 'Packets are sent independently via different routes', 'Routers control the path of each packet', 'Packets arrive at the destination and are reordered', 'Corrupt or missing packets are requested again'] },
            { id: 'q3', title: 'USB Features', type: 'drag', correctAnswer: { true: ['It is an industry standard', 'Devices are automatically detected (plug and play)', 'Connectors fit only one way', 'Can power devices as well as transmit data'], false: ['It uses parallel data transmission', 'It is only used for printers', 'It allows data to travel faster than fibre optic cables'] } },
            { id: 'q4', title: 'Error Checking Methods', type: 'drag', correctAnswer: { parity: ['Uses an extra bit to make 1s even or odd', 'Can be horizontal and vertical'], checksum: ['Calculated value sent at end of data block', 'Uses an algorithm agreed by sender and receiver'], checkdigit: ['Final digit calculated from other digits', 'Used for ISBNs and barcodes'] } },
            { id: 'q5', title: 'Encryption', type: 'dropdown', correctAnswer: { a: 'Symmetric', b: 'Asymmetric', c: 'Public', d: 'Private', e: 'Plaintext', f: 'Ciphertext' } },
            { id: 'q6', title: 'Error Scenarios', type: 'dropdown', correctAnswer: { a: 'Check Digit', b: 'Checksum', c: 'Parity Check', d: 'Echo Check' } }
        ];

        // --- UTILITY: Shuffle Array ---
        function shuffle(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        // --- INITIALIZE ALL SHUFFLED CONTENT ---
        function initQuestions() {
            // Q1 Matching
            const q1D = shuffle(q1Defs);
            const q1T = shuffle(q1Terms);
            const defsContainer = document.getElementById('col-defs');
            const termsContainer = document.getElementById('col-terms');

            q1D.forEach(d => {
                const div = document.createElement('div');
                div.className = 'match-def';
                div.dataset.id = d.id;
                div.textContent = d.text;
                div.onclick = () => selectDef(div, 'q1');
                defsContainer.appendChild(div);
            });

            q1T.forEach(t => {
                const div = document.createElement('div');
                div.className = 'match-term';
                div.dataset.id = t.id;
                div.textContent = t.text;
                div.onclick = () => selectTerm(div, 'q1');
                termsContainer.appendChild(div);
            });

            // Q3 Drag & Drop
            const q3S = shuffle(q3Items);
            const q3Source = document.getElementById('q3-source');
            q3S.forEach(item => {
                const div = document.createElement('div');
                div.className = 'drag-item';
                div.draggable = true;
                div.id = item.id;
                div.textContent = item.text;
                div.dataset.correct = item.correct;
                div.ondragstart = drag;
                q3Source.appendChild(div);
            });

            // Q4 Drag & Drop
            const q4S = shuffle(q4Items);
            const q4Source = document.getElementById('q4-source');
            q4S.forEach(item => {
                const div = document.createElement('div');
                div.className = 'drag-item';
                div.draggable = true;
                div.id = item.id;
                div.textContent = item.text;
                div.dataset.correct = item.correct;
                div.ondragstart = drag;
                q4Source.appendChild(div);
            });

            // Populate Dropdowns
            populateDropdown('q2a', dropdownOptions.q2);
            populateDropdown('q2b', dropdownOptions.q2);
            populateDropdown('q2c', dropdownOptions.q2);
            populateDropdown('q2d', dropdownOptions.q2);
            populateDropdown('q2e', dropdownOptions.q2);
            populateDropdown('q2f', dropdownOptions.q2);

            populateDropdown('q5a', dropdownOptions.q5a);
            populateDropdown('q5b', dropdownOptions.q5b);
            populateDropdown('q5c', dropdownOptions.q5c);
            populateDropdown('q5d', dropdownOptions.q5d);
            populateDropdown('q5e', dropdownOptions.q5e);
            populateDropdown('q5f', dropdownOptions.q5f);

            populateDropdown('q6a', dropdownOptions.q6a);
            populateDropdown('q6b', dropdownOptions.q6b);
            populateDropdown('q6c', dropdownOptions.q6c);
            populateDropdown('q6d', dropdownOptions.q6d);
        }

        function populateDropdown(id, options) {
            const select = document.getElementById(id);
            const shuffled = shuffle(options);
            const defaultOpt = document.createElement('option');
            defaultOpt.value = "";
            defaultOpt.textContent = "---";
            select.appendChild(defaultOpt);
            shuffled.forEach(opt => {
                const el = document.createElement('option');
                el.value = opt;
                el.textContent = opt;
                select.appendChild(el);
            });
        }

        // --- CORE LOGIC ---
        function startAssessment() {
            const teacher = document.getElementById('teacherSelect').value;
            if (!teacher) {
                alert("Please select your teacher.");
                return;
            }
            teacherName = teacher;
            document.getElementById('startOverlay').style.display = 'none';
            document.querySelector('main').style.display = 'block';
            document.getElementById('timerDisplay').style.display = 'block';
            startTime = new Date();
            timerInterval = setInterval(updateTimer, 1000);
            initQuestions();
        }

        function updateTimer() {
            const now = new Date();
            const diff = Math.floor((now - startTime) / 1000);
            const m = Math.floor(diff / 60).toString().padStart(2, '0');
            const s = (diff % 60).toString().padStart(2, '0');
            document.getElementById('timer').textContent = `${m}:${s}`;
            timeTakenStr = `${m}m ${s}s`;
        }

        // --- DRAG & DROP ---
        function allowDrop(ev) { ev.preventDefault(); }
        function drag(ev) { ev.dataTransfer.setData("text", ev.target.id); }
        function drop(ev) {
            ev.preventDefault();
            const data = ev.dataTransfer.getData("text");
            const el = document.getElementById(data);
            if (ev.target.classList.contains('bucket') || ev.target.classList.contains('draggable-source')) {
                ev.target.appendChild(el);
            } else if (ev.target.closest('.bucket')) {
                ev.target.closest('.bucket').appendChild(el);
            }
        }

        // --- MATCHING LOGIC (Generic) ---
        let selectedDef = { q1: null };
        let selectedTerm = { q1: null };
        let matchedPairs = { q1: [] };

        function selectDef(el, qId) {
            if (el.classList.contains('match-solved')) return;
            if (selectedDef[qId]) selectedDef[qId].classList.remove('match-selected');
            selectedDef[qId] = el;
            el.classList.add('match-selected');
            checkMatch(qId);
        }

        function selectTerm(el, qId) {
            if (el.classList.contains('match-solved')) return;
            if (selectedTerm[qId]) selectedTerm[qId].classList.remove('match-selected');
            selectedTerm[qId] = el;
            el.classList.add('match-selected');
            checkMatch(qId);
        }

        function checkMatch(qId) {
            if (selectedDef[qId] && selectedTerm[qId]) {
                selectedDef[qId].classList.remove('match-selected');
                selectedTerm[qId].classList.remove('match-selected');
                selectedDef[qId].classList.add('match-paired');
                selectedTerm[qId].classList.add('match-paired');
                matchedPairs[qId] = matchedPairs[qId].filter(p => p.def !== selectedDef[qId] && p.term !== selectedTerm[qId]);
                matchedPairs[qId].push({
                    def: selectedDef[qId],
                    term: selectedTerm[qId],
                    defId: selectedDef[qId].dataset.id,
                    termId: selectedTerm[qId].dataset.id
                });
                selectedDef[qId] = null;
                selectedTerm[qId] = null;
            }
        }

        // --- CHECK ANSWERS ---
        function checkAnswers() {
            totalAttempts++;
            let allCorrect = true;

            // Q1: Matching
            let q1Correct = true;
            const q1Pairs = matchedPairs.q1;
            if (q1Pairs.length !== 5) q1Correct = false;
            else {
                q1Pairs.forEach(p => {
                    if (p.defId !== p.termId) q1Correct = false;
                });
            }

            if (q1Correct) {
                markCorrect('q1');
                q1Pairs.forEach(p => {
                    p.def.classList.remove('match-paired');
                    p.term.classList.remove('match-paired');
                    p.def.classList.add('match-solved');
                    p.term.classList.add('match-solved');
                });
            } else {
                markWrong('q1');
                allCorrect = false;
            }

            // Q2: Ordering
            const q2a = document.getElementById('q2a');
            const q2b = document.getElementById('q2b');
            const q2c = document.getElementById('q2c');
            const q2d = document.getElementById('q2d');
            const q2e = document.getElementById('q2e');
            const q2f = document.getElementById('q2f');

            if (q2a.value === 'Data is broken down into packets' && q2b.value === 'Each packet is given a header with IP addresses and sequence number' && q2c.value === 'Packets are sent independently via different routes' && q2d.value === 'Routers control the path of each packet' && q2e.value === 'Packets arrive at the destination and are reordered' && q2f.value === 'Corrupt or missing packets are requested again') {
                markCorrect('q2');
                q2a.classList.add('correct');
                q2b.classList.add('correct');
                q2c.classList.add('correct');
                q2d.classList.add('correct');
                q2e.classList.add('correct');
                q2f.classList.add('correct');
            } else {
                markWrong('q2');
                allCorrect = false;
                if (q2a.value !== 'Data is broken down into packets') q2a.classList.add('wrong');
                if (q2b.value !== 'Each packet is given a header with IP addresses and sequence number') q2b.classList.add('wrong');
                if (q2c.value !== 'Packets are sent independently via different routes') q2c.classList.add('wrong');
                if (q2d.value !== 'Routers control the path of each packet') q2d.classList.add('wrong');
                if (q2e.value !== 'Packets arrive at the destination and are reordered') q2e.classList.add('wrong');
                if (q2f.value !== 'Corrupt or missing packets are requested again') q2f.classList.add('wrong');
            }

            // Q3: Drag & Drop
            const bucketTrue = document.getElementById('bucket-true');
            const bucketFalse = document.getElementById('bucket-false');
            let q3Correct = true;

            Array.from(bucketTrue.children).forEach(child => {
                if (child.classList.contains('drag-item')) {
                    if (child.dataset.correct !== 'true') q3Correct = false;
                }
            });
            Array.from(bucketFalse.children).forEach(child => {
                if (child.classList.contains('drag-item')) {
                    if (child.dataset.correct !== 'false') q3Correct = false;
                }
            });
            if (document.getElementById('q3-source').children.length > 0) q3Correct = false;

            if (q3Correct) {
                markCorrect('q3');
                lockDragItems([bucketTrue, bucketFalse]);
            } else {
                markWrong('q3');
                allCorrect = false;
            }

            // Q4: Drag & Drop
            const bucketParity = document.getElementById('bucket-parity');
            const bucketChecksum = document.getElementById('bucket-checksum');
            const bucketCheckdigit = document.getElementById('bucket-checkdigit');
            let q4Correct = true;

            Array.from(bucketParity.children).forEach(child => {
                if (child.classList.contains('drag-item')) {
                    if (child.dataset.correct !== 'parity') q4Correct = false;
                }
            });
            Array.from(bucketChecksum.children).forEach(child => {
                if (child.classList.contains('drag-item')) {
                    if (child.dataset.correct !== 'checksum') q4Correct = false;
                }
            });
            Array.from(bucketCheckdigit.children).forEach(child => {
                if (child.classList.contains('drag-item')) {
                    if (child.dataset.correct !== 'checkdigit') q4Correct = false;
                }
            });
            if (document.getElementById('q4-source').children.length > 0) q4Correct = false;

            if (q4Correct) {
                markCorrect('q4');
                lockDragItems([bucketParity, bucketChecksum, bucketCheckdigit]);
            } else {
                markWrong('q4');
                allCorrect = false;
            }

            // Q5: Dropdowns
            const q5a = document.getElementById('q5a');
            const q5b = document.getElementById('q5b');
            const q5c = document.getElementById('q5c');
            const q5d = document.getElementById('q5d');
            const q5e = document.getElementById('q5e');
            const q5f = document.getElementById('q5f');

            if (checkSelect(q5a) && checkSelect(q5b) && checkSelect(q5c) && checkSelect(q5d) && checkSelect(q5e) && checkSelect(q5f)) {
                markCorrect('q5');
            } else {
                markWrong('q5');
                allCorrect = false;
            }

            // Q6: Dropdowns
            const q6a = document.getElementById('q6a');
            const q6b = document.getElementById('q6b');
            const q6c = document.getElementById('q6c');
            const q6d = document.getElementById('q6d');

            if (checkSelect(q6a) && checkSelect(q6b) && checkSelect(q6c) && checkSelect(q6d)) {
                markCorrect('q6');
            } else {
                markWrong('q6');
                allCorrect = false;
            }

            // Final Completion
            if (allCorrect && !assessmentFinished) {
                assessmentFinished = true;
                clearInterval(timerInterval);
                document.getElementById('btnSubmit').style.display = 'none';
                document.getElementById('btnReturn').style.display = 'inline-block';
                document.getElementById('completionMessage').style.display = 'block';
                document.getElementById('finalScore').textContent = `Attempts: ${totalAttempts} | Time: ${timeTakenStr}`;
                document.getElementById('finalScore').style.display = 'block';
                generatePDF();
            }
        }

        function checkSelect(el) {
            if (el.value === el.dataset.answer) {
                el.classList.add('correct');
                el.classList.remove('wrong');
                return true;
            } else {
                el.classList.add('wrong');
                return false;
            }
        }

        function markCorrect(qId) {
            if (!completed[qId]) {
                completed[qId] = true;
                document.getElementById(`${qId}-status`).textContent = "Correct";
                document.getElementById(`${qId}-status`).className = "q-status correct";
                document.getElementById(`${qId}-block`).style.borderLeftColor = "var(--correct-green)";
            }
        }

        function markWrong(qId) {
            if (!completed[qId]) {
                mistakeCounts[qId]++;
                document.getElementById(`${qId}-status`).textContent = "Incorrect";
                document.getElementById(`${qId}-status`).className = "q-status wrong";
            }
        }

        function lockDragItems(containers) {
            containers.forEach(c => {
                Array.from(c.children).forEach(child => {
                    if (child.classList.contains('drag-item')) {
                        child.draggable = false;
                        child.classList.add('locked');
                    }
                });
            });
        }

        // --- PDF GENERATION ---
        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Page 1: Answers
            doc.setFontSize(20);
            doc.setTextColor(0, 51, 102);
            doc.text(testName, 20, 20);

            doc.setFontSize(12);
            doc.setTextColor(50);
            doc.text(`Teacher: ${teacherName}`, 20, 30);
            doc.text(`Time Taken: ${timeTakenStr}`, 20, 36);
            doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 42);

            let y = 60;
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text("Correct Answers & Justifications", 20, 52);

            doc.setFontSize(10);
            questionMeta.forEach(q => {
                if (y > 270) { doc.addPage(); y = 20; }

                doc.setFont(undefined, 'bold');
                doc.text(`${q.id.toUpperCase()}: ${q.title}`, 20, y);
                y += 5;

                doc.setFont(undefined, 'normal');
                let ansStr = "";
                if (typeof q.correctAnswer === 'object') {
                    ansStr = JSON.stringify(q.correctAnswer).replace(/"/g, '').replace(/,/g, ', ');
                } else {
                    ansStr = q.correctAnswer;
                }

                const splitAns = doc.splitTextToSize(`Answer: ${ansStr}`, 170);
                doc.text(splitAns, 20, y);
                y += (splitAns.length * 5) + 5;
            });

            // Page 2: Feedback
            doc.addPage();
            doc.setFontSize(16);
            doc.text("Feedback & Reflection", 20, 20);

            // Table Header
            let ty = 40;
            doc.setFontSize(10);
            doc.setFillColor(240, 240, 240);
            doc.rect(20, ty - 5, 170, 8, 'F');
            doc.text("Question", 25, ty);
            doc.text("Attempts", 80, ty);
            doc.text("Feedback Code", 130, ty);
            ty += 10;

            // Table Rows
            Object.keys(mistakeCounts).forEach(q => {
                doc.text(q.toUpperCase(), 25, ty);
                doc.text((mistakeCounts[q] + 1).toString(), 85, ty);
                doc.rect(130, ty - 4, 30, 6);
                ty += 10;
            });

            // Key
            ty += 10;
            doc.setFont(undefined, 'bold');
            doc.text("Feedback Codes:", 20, ty);
            ty += 6;
            doc.setFont(undefined, 'normal');
            doc.text("C: Content gap", 20, ty); ty += 5;
            doc.text("E: Exam technique", 20, ty); ty += 5;
            doc.text("L: Language/clarity", 20, ty); ty += 5;
            doc.text("T: Time/effort", 20, ty); ty += 5;
            doc.text("M: Misread/misapplied", 20, ty);

            // Reflection Boxes
            ty += 15;
            doc.setDrawColor(40, 167, 69); // Green
            doc.setLineWidth(1);
            doc.rect(20, ty, 170, 40);
            doc.setTextColor(40, 167, 69);
            doc.text("Student Reflection:", 25, ty + 8);

            ty += 50;
            doc.setDrawColor(111, 66, 193); // Purple
            doc.rect(20, ty, 170, 40);
            doc.setTextColor(111, 66, 193);
            doc.text("Teacher Comment:", 25, ty + 8);

            doc.save(`${testName.replace(/ /g, '_')}_Feedback.pdf`);
        }
    </script>
</body>

</html>