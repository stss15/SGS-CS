<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2.3 Encryption Assessment | St George's CS</title>
    <!-- version: retryable-assessment v4 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --sg-blue: #003366;
            --sg-gold: #D4AF37;
            --sg-text: #333333;
            --sg-light-blue: #e6f0fa;
            --sg-grey: #f4f6f8;
            --correct-green: #28a745;
            --wrong-red: #dc3545;
            --paired-amber: #f0ad4e;
            --reflection-green: #28a745;
            --teacher-purple: #6f42c1;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            color: var(--sg-text);
            background-color: #ffffff;
            line-height: 1.6;
            padding-bottom: 100px;
        }

        /* Start Modal */
        #startOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 51, 102, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        #startCard {
            background: white;
            padding: 40px;
            border-radius: 16px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            border-top: 6px solid var(--sg-gold);
        }

        #startCard h2 {
            color: var(--sg-blue);
            margin-bottom: 8px;
            font-size: 1.8rem;
        }

        #startCard .test-name {
            color: var(--sg-gold);
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 20px;
        }

        #startCard .instructions {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        #startCard label {
            font-size: 0.9rem;
            color: #555;
            display: block;
            text-align: left;
            margin-bottom: 6px;
            font-weight: 600;
        }

        #startCard select {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            background: white;
        }

        #startCard select:focus {
            border-color: var(--sg-blue);
            outline: none;
        }

        #startCard button {
            width: 100%;
            padding: 14px;
            background: var(--sg-blue);
            color: white;
            border: none;
            border-radius: 30px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        #startCard button:hover {
            background: var(--sg-gold);
            transform: translateY(-2px);
        }

        /* Timer Display */
        #timerDisplay {
            position: fixed;
            top: 18px;
            right: 100px;
            color: var(--sg-blue);
            font-size: 1rem;
            font-weight: 600;
            z-index: 900;
            background: white;
            padding: 8px 16px;
            border-radius: 20px;
            border: 2px solid var(--sg-blue);
        }

        /* Header */
        header {
            background: white;
            padding: 1.5rem;
            border-bottom: 4px solid var(--sg-gold);
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        h1 {
            color: var(--sg-blue);
            margin-bottom: 0.5rem;
        }

        p.subtitle {
            color: #666;
            font-size: 0.9rem;
        }

        /* Main Content */
        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .question-block {
            background: var(--sg-grey);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 40px;
            border-left: 5px solid var(--sg-blue);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .q-header {
            font-weight: 700;
            color: var(--sg-blue);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .q-status {
            font-size: 0.8rem;
            padding: 4px 12px;
            border-radius: 20px;
            background: #ddd;
            color: #666;
        }

        .q-status.correct {
            background: var(--correct-green);
            color: white;
        }

        .q-status.wrong {
            background: var(--wrong-red);
            color: white;
        }

        /* Drag & Drop Styles */
        .bucket-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .bucket {
            flex: 1;
            background: white;
            border: 2px dashed #ccc;
            border-radius: 8px;
            min-height: 200px;
            padding: 15px;
            position: relative;
        }

        .bucket h4 {
            text-align: center;
            color: var(--sg-blue);
            margin-bottom: 10px;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .draggable-source {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border: 1px solid #eee;
            border-radius: 8px;
            min-height: 60px;
        }

        .drag-item {
            background: var(--sg-blue);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: grab;
            user-select: none;
            transition: transform 0.1s;
        }

        .drag-item:active {
            cursor: grabbing;
            transform: scale(1.05);
        }

        .drag-item.locked {
            background: var(--correct-green);
            cursor: default;
        }

        /* Dropdown Styles */
        .cloze-text {
            line-height: 2.2;
            font-size: 1.05rem;
        }

        select {
            padding: 5px 10px;
            border: 2px solid var(--sg-blue);
            border-radius: 5px;
            background: white;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            margin: 0 5px;
            font-size: 0.95rem;
        }

        select.correct {
            border-color: var(--correct-green);
            background: #e8f5e9;
            color: var(--correct-green);
            pointer-events: none;
        }

        select.wrong {
            border-color: var(--wrong-red);
            background: #f8d7da;
        }

        /* Ordering Lists */
        .order-list {
            list-style: none;
            padding: 0;
        }

        .order-item {
            background: white;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .order-num {
            font-weight: bold;
            color: var(--sg-gold);
        }

        /* Sortable List */
        .sortable-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sortable-item {
            background: white;
            border: 1px solid #ccc;
            border-left: 4px solid var(--sg-gold);
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 600;
            color: var(--sg-text);
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s;
        }

        .sortable-item:active {
            cursor: grabbing;
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .sortable-item i {
            color: #ccc;
        }

        .sortable-list.correct .sortable-item {
            border-color: var(--correct-green);
            border-left-color: var(--correct-green);
            background-color: #e8f5e9;
            cursor: default;
        }

        .sortable-list.wrong .sortable-item {
            border-left-color: var(--wrong-red);
            background-color: #fff5f5;
        }

        /* MCQ Styles */
        .mcq-options { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .mcq-option { background: white; border: 2px solid #ccc; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.2s; }
        .mcq-option:hover { border-color: var(--sg-gold); background: var(--sg-light-blue); }
        .mcq-option.selected { background: var(--sg-blue); color: white; border-color: var(--sg-blue); }
        .mcq-option.correct { background: var(--correct-green); color: white; border-color: var(--correct-green); pointer-events: none; }
        .mcq-option.wrong { border-color: var(--wrong-red); background: #f8d7da; }

        /* True/False Table */
        .tf-table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; border-radius: 8px; overflow: hidden; }
        .tf-table th, .tf-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .tf-table th { background: var(--sg-blue); color: white; }
        .tf-table th:nth-child(2), .tf-table th:nth-child(3), .tf-table td:nth-child(2), .tf-table td:nth-child(3) { text-align: center; width: 80px; }
        .tf-table input[type="radio"] { transform: scale(1.3); cursor: pointer; }
        .tf-table tr.correct-row { background: #e8f5e9; }
        .tf-table tr.wrong-row { background: #f8d7da; }

        /* Matching Pairs */
        .match-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            align-items: start;
        }

        .col-defs,
        .col-terms {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .match-term,
        .match-def {
            background: white;
            padding: 15px;
            border: 2px solid #ccc;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .match-term:hover,
        .match-def:hover {
            border-color: var(--sg-gold);
            background: var(--sg-light-blue);
        }

        .match-selected {
            background: var(--sg-blue) !important;
            color: white !important;
            border-color: var(--sg-blue) !important;
        }

        .match-paired {
            background: #fff3cd !important;
            border-color: var(--paired-amber) !important;
            color: #856404 !important;
        }

        .match-solved {
            background: var(--correct-green) !important;
            color: white !important;
            border-color: var(--correct-green) !important;
            opacity: 0.8;
            pointer-events: none;
        }

        /* Footer Controls */
        .controls {
            text-align: center;
            margin-top: 40px;
        }

        .btn-submit {
            background: var(--sg-blue);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2rem;
            font-weight: 700;
            border-radius: 30px;
            cursor: pointer;
            transition: background 0.3s;
            box-shadow: 0 4px 15px rgba(0, 51, 102, 0.2);
        }

        .btn-submit:hover {
            background: var(--sg-gold);
            transform: translateY(-2px);
        }

        #finalScore {
            margin-top: 20px;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--sg-blue);
            display: none;
        }

        /* Back Button */
        #back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            font-size: 1.5rem;
            color: var(--sg-blue);
            text-decoration: none;
            transition: color 0.3s;
        }

        #back-btn:hover {
            color: var(--sg-gold);
        }

        /* Logo */
        #sg-logo {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 80px;
            z-index: 1000;
        }

        .btn-return {
            background: var(--sg-grey);
            color: var(--sg-text);
            border: 2px solid #ccc;
            padding: 15px 40px;
            font-size: 1.2rem;
            font-weight: 700;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: none;
            margin-left: 10px;
        }

        .btn-return:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }

        /* Completion Message */
        .completion-message {
            display: none;
            background: linear-gradient(135deg, var(--correct-green), #20c997);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-top: 20px;
        }

        .completion-message h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .completion-message p {
            font-size: 1rem;
            opacity: 0.9;
        }
    </style>
</head>

<body>
    <!-- Start Modal -->
    <div id="startOverlay">
        <div id="startCard">
            <h2>Assessment</h2>
            <div class="test-name">2.3 Encryption</div>
            <p class="instructions">
                Answer all questions by selecting from dropdowns, dragging items, or matching pairs.
                You must get all answers correct to complete the assessment.
                Your attempts are tracked and a feedback PDF will be generated upon completion.
            </p>
            <label for="teacherSelect">Select Your Teacher</label>
            <select id="teacherSelect">
                <option value="" disabled selected>Choose teacher...</option>
                <option value="Mr Stewart">Mr Stewart</option>
                <option value="Mr Watling">Mr Watling</option>
            </select>
            <button onclick="startAssessment()">Start Assessment</button>
        </div>
    </div>

    <div id="timerDisplay" style="display:none;"><i class="fa-solid fa-clock"></i> <span id="timer">00:00</span></div>

    <!-- Back Button -->
    <a href="assessments.html" id="back-btn" title="Back to Topic 2 Assessments"><i
            class="fa-solid fa-circle-arrow-left"></i></a>

    <!-- Logo -->
    <img src="../../images/Logo.png" id="sg-logo" alt="Logo">

    <header>
        <h1>2.3 Assessment</h1>
        <p class="subtitle">Symmetric and Asymmetric Encryption</p>
    </header>

    <main style="display:none;">

        <!-- Q1: Encryption Terminology (Matching) -->
        <div class="question-block" id="q1-block" data-summary="Match encryption terms">
            <div class="q-header">
                <span>Q1. Encryption Terminology</span>
                <span class="q-status" id="q1-status">Unanswered</span>
            </div>
            <p>Click a definition on the left, then the matching term on the right. Matched pairs will turn <span
                    style="color: #f0ad4e; font-weight: bold;">amber</span>.</p>

            <div class="match-grid">
                <div class="col-defs" id="col-defs">
                    <!-- Shuffled by JS -->
                </div>
                <div class="col-terms" id="col-terms">
                    <!-- Shuffled by JS -->
                </div>
            </div>
        </div>

        <!-- Q2: Symmetric vs Asymmetric (Categorisation) -->
        <div class="question-block" id="q2-block" data-summary="Symmetric vs Asymmetric features">
            <div class="q-header">
                <span>Q2. Symmetric vs Asymmetric Encryption</span>
                <span class="q-status" id="q2-status">Unanswered</span>
            </div>
            <p>Drag the statements into the correct category.</p>
            <div class="draggable-source" id="q2-source" ondrop="drop(event)" ondragover="allowDrop(event)">
                <!-- Items will be shuffled by JS -->
            </div>
            <div class="bucket-container">
                <div class="bucket" id="bucket-symmetric" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <h4>Symmetric Encryption</h4>
                </div>
                <div class="bucket" id="bucket-asymmetric" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <h4>Asymmetric Encryption</h4>
                </div>
            </div>
        </div>

        <!-- Q3: Asymmetric Process (Ordering) -->
        <div class="question-block" id="q3-block" data-summary="Asymmetric encryption process">
            <div class="q-header">
                <span>Q3. Asymmetric Encryption Process</span>
                <span class="q-status" id="q3-status">Unanswered</span>
            </div>
            <p>Order the steps for Tom to send a secret message to Jane.</p>
            <div class="order-list">
                <div class="order-item"><span class="order-num">1.</span> <select id="q3a"
                        data-answer="Jane generates a public/private key pair"></select></div>
                <div class="order-item"><span class="order-num">2.</span> <select id="q3b"
                        data-answer="Jane sends her public key to Tom"></select></div>
                <div class="order-item"><span class="order-num">3.</span> <select id="q3c"
                        data-answer="Tom encrypts the message using Jane's public key"></select></div>
                <div class="order-item"><span class="order-num">4.</span> <select id="q3d"
                        data-answer="Tom sends the ciphertext to Jane"></select></div>
                <div class="order-item"><span class="order-num">5.</span> <select id="q3e"
                        data-answer="Jane decrypts the message using her private key"></select></div>
            </div>
        </div>

        <!-- Q4: Encryption Purpose (Dropdown Gap Fill) -->
        <div class="question-block" id="q4-block" data-summary="Purpose of encryption">
            <div class="q-header">
                <span>Q4. Purpose of Encryption</span>
                <span class="q-status" id="q4-status">Unanswered</span>
            </div>
            <div class="cloze-text">
                Encryption is used to protect data from <select id="q4a" data-answer="eavesdroppers"></select>.<br>
                It turns <select id="q4b" data-answer="plaintext"></select> into <select id="q4c"
                    data-answer="ciphertext"></select>.<br>
                It does not prevent interception, but makes the data <select id="q4d"
                    data-answer="unreadable"></select>.<br>
                This is essential for sending sensitive info like <select id="q4e"
                    data-answer="credit card details"></select> over the internet.<br>
                https websites use <select id="q4f" data-answer="SSL/TLS"></select> to secure data.
            </div>
        </div>

        <!-- Q5: Caesar Cipher Logic (Dropdown) -->
        <div class="question-block" id="q5-block" data-summary="Simple shift cipher logic">
            <div class="q-header">
                <span>Q5. Simple Shift Cipher</span>
                <span class="q-status" id="q5-status">Unanswered</span>
            </div>
            <div class="cloze-text">
                Using a shift of +3 (A -> D):<br>
                The plaintext "CAT" becomes <select id="q5a" data-answer="FDW"></select>.<br>
                The ciphertext "DPH" decrypts to <select id="q5b" data-answer="AME"></select>.<br>
                If the key is lost, the data cannot be <select id="q5c" data-answer="decrypted"></select>.<br>
                This is a type of <select id="q5d" data-answer="symmetric"></select> encryption.
            </div>
        </div>

        <!-- Q6: Public/Private Key Roles (True/False Drag) -->
        <div class="question-block" id="q6-block" data-summary="Roles of public and private keys">
            <div class="q-header">
                <span>Q6. Public vs Private Key Roles</span>
                <span class="q-status" id="q6-status">Unanswered</span>
            </div>
            <p>Drag the statements into the correct category (True or False).</p>
            <div class="draggable-source" id="q6-source" ondrop="drop(event)" ondragover="allowDrop(event)">
                <!-- Items will be shuffled by JS -->
            </div>
            <div class="bucket-container">
                <div class="bucket" id="bucket-true" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <h4>True Statements</h4>
                </div>
                <div class="bucket" id="bucket-false" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <h4>False Statements</h4>
                </div>
            </div>
        </div>

        <!-- Q7: Encryption Benefits (MCQ) -->
        <div class="question-block" id="q7-block" data-summary="Key benefit of asymmetric encryption">
            <div class="q-header">
                <span>Q7. Asymmetric Encryption Benefit</span>
                <span class="q-status" id="q7-status">Unanswered</span>
            </div>
            <p>What is the main advantage of asymmetric encryption over symmetric encryption?</p>
            <div class="mcq-options" id="q7-options"></div>
        </div>

        <!-- Q8: Encryption Facts (True/False Grid) -->
        <div class="question-block" id="q8-block" data-summary="Facts about encryption">
            <div class="q-header">
                <span>Q8. Encryption Facts</span>
                <span class="q-status" id="q8-status">Unanswered</span>
            </div>
            <p>Select True or False for each statement.</p>
            <table class="tf-table" id="q8-table">
                <thead><tr><th>Statement</th><th>True</th><th>False</th></tr></thead>
                <tbody id="q8-tbody"></tbody>
            </table>
        </div>

        <!-- Q9: Symmetric Encryption Steps (Sortable List) -->
        <div class="question-block" id="q9-block" data-summary="Symmetric encryption process">
            <div class="q-header">
                <span>Q9. Symmetric Encryption Process</span>
                <span class="q-status" id="q9-status">Unanswered</span>
            </div>
            <p>Drag to arrange the symmetric encryption process in order.</p>
            <ul class="sortable-list" id="q9-list"></ul>
        </div>

        <!-- Q10: Encryption Applications (Dropdown) -->
        <div class="question-block" id="q10-block" data-summary="Where encryption is used">
            <div class="q-header">
                <span>Q10. Encryption Applications</span>
                <span class="q-status" id="q10-status">Unanswered</span>
            </div>
            <div class="cloze-text">
                Online banking uses encryption to protect <select id="q10a" data-answer="financial transactions"></select>.<br>
                The padlock icon in a browser indicates <select id="q10b" data-answer="HTTPS"></select> is being used.<br>
                Email can be encrypted to ensure only the <select id="q10c" data-answer="intended recipient"></select> can read it.<br>
                VPNs use encryption to create a secure <select id="q10d" data-answer="tunnel"></select> over public networks.
            </div>
        </div>

        <div class="controls">
            <button class="btn-submit" id="btnSubmit" onclick="checkAnswers()">Submit Answers</button>
            <a href="assessments.html" class="btn-return" id="btnReturn">Return to Menu</a>
            <div id="finalScore"></div>
            <div class="completion-message" id="completionMessage">
                <h3><i class="fa-solid fa-trophy"></i> Assessment Complete!</h3>
                <p>Your feedback PDF is downloading...</p>
            </div>
        </div>

    </main>

    <script>
        // --- SESSION / TRACKING ---
        let startTime;
        let timerInterval;
        let timeTakenStr = "";
        let teacherName = "";
        const testName = "2.3 Encryption";

        // Attempt tracking
        const mistakeCounts = { q1: 0, q2: 0, q3: 0, q4: 0, q5: 0, q6: 0, q7: 0, q8: 0, q9: 0, q10: 0 };
        const completed = { q1: false, q2: false, q3: false, q4: false, q5: false, q6: false, q7: false, q8: false, q9: false, q10: false };
        let totalAttempts = 0;
        let assessmentFinished = false;

        // --- DATA FOR QUESTIONS ---

        // Q1 Data
        const q1Defs = [
            { id: '1', text: 'The original message before encryption' },
            { id: '2', text: 'The scrambled message after encryption' },
            { id: '3', text: 'The formula used to scramble the data' },
            { id: '4', text: 'A secret value used to encrypt/decrypt' },
            { id: '5', text: 'Uses the same key for encryption and decryption' },
            { id: '6', text: 'Uses a public key and a private key' }
        ];

        const q1Terms = [
            { id: '1', text: 'Plaintext' },
            { id: '2', text: 'Ciphertext' },
            { id: '3', text: 'Encryption Algorithm' },
            { id: '4', text: 'Key' },
            { id: '5', text: 'Symmetric Encryption' },
            { id: '6', text: 'Asymmetric Encryption' }
        ];

        // Q2 Data
        const q2Items = [
            { id: 's1', text: 'Uses a single key', correct: 'symmetric' },
            { id: 's2', text: 'Faster to process', correct: 'symmetric' },
            { id: 's3', text: 'Key distribution is a security risk', correct: 'symmetric' },
            { id: 'a1', text: 'Uses a public and private key pair', correct: 'asymmetric' },
            { id: 'a2', text: 'Public key can be shared with anyone', correct: 'asymmetric' },
            { id: 'a3', text: 'More secure for key exchange', correct: 'asymmetric' }
        ];

        // Q6 Data
        const q6Items = [
            { id: 't1', text: 'A public key can be given to anyone', correct: 'true' },
            { id: 't2', text: 'A private key must be kept secret', correct: 'true' },
            { id: 't3', text: 'Data encrypted with a public key can only be decrypted by the matching private key', correct: 'true' },
            { id: 'f1', text: 'A public key can decrypt messages created with the public key', correct: 'false' },
            { id: 'f2', text: 'Private keys are shared with the sender', correct: 'false' },
            { id: 'f3', text: 'Symmetric encryption uses two different keys', correct: 'false' }
        ];

        // Dropdown Options
        const dropdownOptions = {
            q3: ['Jane generates a public/private key pair', 'Jane sends her public key to Tom', 'Tom encrypts the message using Jane\'s public key', 'Tom sends the ciphertext to Jane', 'Jane decrypts the message using her private key'],
            q4a: ['eavesdroppers', 'viruses', 'bugs'],
            q4b: ['plaintext', 'simpletext', 'rawtext'],
            q4c: ['ciphertext', 'codedtext', 'secrettext'],
            q4d: ['unreadable', 'deleted', 'invisible'],
            q4e: ['credit card details', 'public news', 'weather reports'],
            q4f: ['SSL/TLS', 'HTML', 'FTP'],
            q5a: ['FDW', 'DBU', 'XZQ'],
            q5b: ['AME', 'BND', 'ZKD'],
            q5c: ['decrypted', 'deleted', 'copied'],
            q5d: ['symmetric', 'asymmetric', 'hashing'],
            q10a: ['financial transactions', 'weather data', 'public records'],
            q10b: ['HTTPS', 'HTTP', 'FTP'],
            q10c: ['intended recipient', 'anyone', 'server'],
            q10d: ['tunnel', 'bridge', 'gateway']
        };

        // Q7 MCQ Data
        const q7Options = [
            { text: 'No need to share secret keys over insecure channels', correct: true },
            { text: 'Faster processing speed', correct: false },
            { text: 'Uses less computing power', correct: false },
            { text: 'Simpler to implement', correct: false }
        ];
        let q7Selected = null;

        // Q8 True/False Data
        const q8Statements = [
            { id: 'tf1', text: 'The private key should never be shared with anyone', correct: true },
            { id: 'tf2', text: 'Symmetric encryption uses two different keys', correct: false },
            { id: 'tf3', text: 'HTTPS websites use encryption', correct: true },
            { id: 'tf4', text: 'Asymmetric encryption is slower than symmetric', correct: true }
        ];

        // Q9 Sortable Data (Symmetric steps)
        const q9Items = [
            { id: 'se1', text: 'Both parties agree on a secret key', order: 1 },
            { id: 'se2', text: 'Key is shared securely', order: 2 },
            { id: 'se3', text: 'Sender encrypts plaintext with the key', order: 3 },
            { id: 'se4', text: 'Ciphertext is sent to receiver', order: 4 },
            { id: 'se5', text: 'Receiver decrypts with the same key', order: 5 }
        ];

        // Question Metadata
        const questionMeta = [
            { id: 'q1', title: 'Encryption Terminology', type: 'match', correctAnswer: { '1': 'Plaintext', '2': 'Ciphertext', '3': 'Encryption Algorithm', '4': 'Key', '5': 'Symmetric Encryption', '6': 'Asymmetric Encryption' } },
            { id: 'q2', title: 'Symmetric vs Asymmetric', type: 'drag', correctAnswer: { symmetric: ['Uses a single key', 'Faster to process', 'Key distribution is a security risk'], asymmetric: ['Uses a public and private key pair', 'Public key can be shared with anyone', 'More secure for key exchange'] } },
            { id: 'q3', title: 'Asymmetric Process', type: 'order', correctAnswer: ['Jane generates a public/private key pair', 'Jane sends her public key to Tom', 'Tom encrypts the message using Jane\'s public key', 'Tom sends the ciphertext to Jane', 'Jane decrypts the message using her private key'] },
            { id: 'q4', title: 'Purpose of Encryption', type: 'dropdown', correctAnswer: { a: 'eavesdroppers', b: 'plaintext', c: 'ciphertext', d: 'unreadable', e: 'credit card details', f: 'SSL/TLS' } },
            { id: 'q5', title: 'Caesar Cipher', type: 'dropdown', correctAnswer: { a: 'FDW', b: 'AME', c: 'decrypted', d: 'symmetric' } },
            { id: 'q7', title: 'Asymmetric Benefit', type: 'mcq', correctAnswer: 'No need to share secret keys over insecure channels' },
            { id: 'q8', title: 'Encryption Facts', type: 'trueFalse', correctAnswer: { tf1: true, tf2: false, tf3: true, tf4: true } },
            { id: 'q9', title: 'Symmetric Process', type: 'sortable', correctAnswer: ['Both parties agree on a secret key', 'Key is shared securely', 'Sender encrypts plaintext with the key', 'Ciphertext is sent to receiver', 'Receiver decrypts with the same key'] },
            { id: 'q10', title: 'Encryption Applications', type: 'dropdown', correctAnswer: { a: 'financial transactions', b: 'HTTPS', c: 'intended recipient', d: 'tunnel' } },
            { id: 'q6', title: 'Key Roles', type: 'drag', correctAnswer: { true: ['A public key can be given to anyone', 'A private key must be kept secret', 'Data encrypted with a public key can only be decrypted by the matching private key'], false: ['A public key can decrypt messages created with the public key', 'Private keys are shared with the sender', 'Symmetric encryption uses two different keys'] } }
        ];

        // --- UTILITY: Shuffle Array ---
        function shuffle(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        // --- INITIALIZE ALL SHUFFLED CONTENT ---
        function initQuestions() {
            // Q1 Matching
            const q1D = shuffle(q1Defs);
            const q1T = shuffle(q1Terms);
            const defsContainer = document.getElementById('col-defs');
            const termsContainer = document.getElementById('col-terms');

            q1D.forEach(d => {
                const div = document.createElement('div');
                div.className = 'match-def';
                div.dataset.id = d.id;
                div.textContent = d.text;
                div.onclick = () => selectDef(div, 'q1');
                defsContainer.appendChild(div);
            });

            q1T.forEach(t => {
                const div = document.createElement('div');
                div.className = 'match-term';
                div.dataset.id = t.id;
                div.textContent = t.text;
                div.onclick = () => selectTerm(div, 'q1');
                termsContainer.appendChild(div);
            });

            // Q2 Drag & Drop
            const q2S = shuffle(q2Items);
            const q2Source = document.getElementById('q2-source');
            q2S.forEach(item => {
                const div = document.createElement('div');
                div.className = 'drag-item';
                div.draggable = true;
                div.id = item.id;
                div.textContent = item.text;
                div.dataset.correct = item.correct;
                div.ondragstart = drag;
                q2Source.appendChild(div);
            });

            // Q6 Drag & Drop
            const q6S = shuffle(q6Items);
            const q6Source = document.getElementById('q6-source');
            q6S.forEach(item => {
                const div = document.createElement('div');
                div.className = 'drag-item';
                div.draggable = true;
                div.id = item.id;
                div.textContent = item.text;
                div.dataset.correct = item.correct;
                div.ondragstart = drag;
                q6Source.appendChild(div);
            });

            // Populate Dropdowns
            populateDropdown('q3a', dropdownOptions.q3);
            populateDropdown('q3b', dropdownOptions.q3);
            populateDropdown('q3c', dropdownOptions.q3);
            populateDropdown('q3d', dropdownOptions.q3);
            populateDropdown('q3e', dropdownOptions.q3);

            populateDropdown('q4a', dropdownOptions.q4a);
            populateDropdown('q4b', dropdownOptions.q4b);
            populateDropdown('q4c', dropdownOptions.q4c);
            populateDropdown('q4d', dropdownOptions.q4d);
            populateDropdown('q4e', dropdownOptions.q4e);
            populateDropdown('q4f', dropdownOptions.q4f);

            populateDropdown('q5a', dropdownOptions.q5a);
            populateDropdown('q5b', dropdownOptions.q5b);
            populateDropdown('q5c', dropdownOptions.q5c);
            populateDropdown('q5d', dropdownOptions.q5d);

            // Q7 MCQ
            const q7Container = document.getElementById('q7-options');
            shuffle(q7Options).forEach(opt => {
                const div = document.createElement('div');
                div.className = 'mcq-option';
                div.dataset.correct = opt.correct;
                div.dataset.value = opt.text;
                div.textContent = opt.text;
                div.onclick = () => selectMCQ(div, 'q7');
                q7Container.appendChild(div);
            });

            // Q8 True/False Grid
            const q8Tbody = document.getElementById('q8-tbody');
            shuffle(q8Statements).forEach(stmt => {
                const tr = document.createElement('tr');
                tr.dataset.id = stmt.id;
                tr.dataset.correct = stmt.correct;
                tr.innerHTML = `<td>${stmt.text}</td><td><input type="radio" name="${stmt.id}" value="true"></td><td><input type="radio" name="${stmt.id}" value="false"></td>`;
                q8Tbody.appendChild(tr);
            });

            // Q9 Sortable List
            const q9List = document.getElementById('q9-list');
            shuffle(q9Items).forEach(item => {
                const li = document.createElement('li');
                li.className = 'sortable-item';
                li.draggable = true;
                li.dataset.order = item.order;
                li.innerHTML = `${item.text} <i class="fa-solid fa-grip-lines"></i>`;
                li.ondragstart = dragSortable;
                li.ondragover = dragOverSortable;
                li.ondrop = dropSortable;
                q9List.appendChild(li);
            });

            // Q10 Dropdowns
            populateDropdown('q10a', dropdownOptions.q10a);
            populateDropdown('q10b', dropdownOptions.q10b);
            populateDropdown('q10c', dropdownOptions.q10c);
            populateDropdown('q10d', dropdownOptions.q10d);
        }

        function selectMCQ(el, qId) {
            if (completed[qId]) return;
            el.parentElement.querySelectorAll('.mcq-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
            if (qId === 'q7') q7Selected = el.dataset.value;
        }

        let draggedSortable = null;
        function dragSortable(ev) { draggedSortable = ev.target; ev.target.style.opacity = '0.5'; }
        function dragOverSortable(ev) { ev.preventDefault(); }
        function dropSortable(ev) {
            ev.preventDefault();
            if (ev.target.classList.contains('sortable-item') && draggedSortable !== ev.target) {
                const items = Array.from(ev.target.parentElement.children);
                if (items.indexOf(draggedSortable) < items.indexOf(ev.target)) ev.target.after(draggedSortable);
                else ev.target.before(draggedSortable);
            }
            draggedSortable.style.opacity = '1';
            draggedSortable = null;
        }

        function populateDropdown(id, options) {
            const select = document.getElementById(id);
            const shuffled = shuffle(options);
            const defaultOpt = document.createElement('option');
            defaultOpt.value = "";
            defaultOpt.textContent = "---";
            select.appendChild(defaultOpt);
            shuffled.forEach(opt => {
                const el = document.createElement('option');
                el.value = opt;
                el.textContent = opt;
                select.appendChild(el);
            });
        }

        // --- CORE LOGIC ---
        function startAssessment() {
            const teacher = document.getElementById('teacherSelect').value;
            if (!teacher) {
                alert("Please select your teacher.");
                return;
            }
            teacherName = teacher;
            document.getElementById('startOverlay').style.display = 'none';
            document.querySelector('main').style.display = 'block';
            document.getElementById('timerDisplay').style.display = 'block';
            startTime = new Date();
            timerInterval = setInterval(updateTimer, 1000);
            initQuestions();
        }

        function updateTimer() {
            const now = new Date();
            const diff = Math.floor((now - startTime) / 1000);
            const m = Math.floor(diff / 60).toString().padStart(2, '0');
            const s = (diff % 60).toString().padStart(2, '0');
            document.getElementById('timer').textContent = `${m}:${s}`;
            timeTakenStr = `${m}m ${s}s`;
        }

        // --- DRAG & DROP ---
        function allowDrop(ev) { ev.preventDefault(); }
        function drag(ev) { ev.dataTransfer.setData("text", ev.target.id); }
        function drop(ev) {
            ev.preventDefault();
            const data = ev.dataTransfer.getData("text");
            const el = document.getElementById(data);
            if (ev.target.classList.contains('bucket') || ev.target.classList.contains('draggable-source')) {
                ev.target.appendChild(el);
            } else if (ev.target.closest('.bucket')) {
                ev.target.closest('.bucket').appendChild(el);
            }
        }

        // --- MATCHING LOGIC (Generic) ---
        let selectedDef = { q1: null };
        let selectedTerm = { q1: null };
        let matchedPairs = { q1: [] };

        function selectDef(el, qId) {
            if (el.classList.contains('match-solved')) return;
            if (selectedDef[qId]) selectedDef[qId].classList.remove('match-selected');
            selectedDef[qId] = el;
            el.classList.add('match-selected');
            checkMatch(qId);
        }

        function selectTerm(el, qId) {
            if (el.classList.contains('match-solved')) return;
            if (selectedTerm[qId]) selectedTerm[qId].classList.remove('match-selected');
            selectedTerm[qId] = el;
            el.classList.add('match-selected');
            checkMatch(qId);
        }

        function checkMatch(qId) {
            if (selectedDef[qId] && selectedTerm[qId]) {
                selectedDef[qId].classList.remove('match-selected');
                selectedTerm[qId].classList.remove('match-selected');
                selectedDef[qId].classList.add('match-paired');
                selectedTerm[qId].classList.add('match-paired');
                matchedPairs[qId] = matchedPairs[qId].filter(p => p.def !== selectedDef[qId] && p.term !== selectedTerm[qId]);
                matchedPairs[qId].push({
                    def: selectedDef[qId],
                    term: selectedTerm[qId],
                    defId: selectedDef[qId].dataset.id,
                    termId: selectedTerm[qId].dataset.id
                });
                selectedDef[qId] = null;
                selectedTerm[qId] = null;
            }
        }

        // --- CHECK ANSWERS ---
        function checkAnswers() {
            totalAttempts++;
            let allCorrect = true;

            // Q1: Matching
            let q1Correct = true;
            const q1Pairs = matchedPairs.q1;
            if (q1Pairs.length !== 6) q1Correct = false;
            else {
                q1Pairs.forEach(p => {
                    if (p.defId !== p.termId) q1Correct = false;
                });
            }

            if (q1Correct) {
                markCorrect('q1');
                q1Pairs.forEach(p => {
                    p.def.classList.remove('match-paired');
                    p.term.classList.remove('match-paired');
                    p.def.classList.add('match-solved');
                    p.term.classList.add('match-solved');
                });
            } else {
                markWrong('q1');
                allCorrect = false;
            }

            // Q2: Drag & Drop
            const bucketSym = document.getElementById('bucket-symmetric');
            const bucketAsym = document.getElementById('bucket-asymmetric');
            let q2Correct = true;

            Array.from(bucketSym.children).forEach(child => {
                if (child.classList.contains('drag-item')) {
                    if (child.dataset.correct !== 'symmetric') q2Correct = false;
                }
            });
            Array.from(bucketAsym.children).forEach(child => {
                if (child.classList.contains('drag-item')) {
                    if (child.dataset.correct !== 'asymmetric') q2Correct = false;
                }
            });
            if (document.getElementById('q2-source').children.length > 0) q2Correct = false;

            if (q2Correct) {
                markCorrect('q2');
                lockDragItems([bucketSym, bucketAsym]);
            } else {
                markWrong('q2');
                allCorrect = false;
            }

            // Q3: Ordering
            const q3a = document.getElementById('q3a');
            const q3b = document.getElementById('q3b');
            const q3c = document.getElementById('q3c');
            const q3d = document.getElementById('q3d');
            const q3e = document.getElementById('q3e');

            if (q3a.value === 'Jane generates a public/private key pair' && q3b.value === 'Jane sends her public key to Tom' && q3c.value === 'Tom encrypts the message using Jane\'s public key' && q3d.value === 'Tom sends the ciphertext to Jane' && q3e.value === 'Jane decrypts the message using her private key') {
                markCorrect('q3');
                q3a.classList.add('correct');
                q3b.classList.add('correct');
                q3c.classList.add('correct');
                q3d.classList.add('correct');
                q3e.classList.add('correct');
            } else {
                markWrong('q3');
                allCorrect = false;
                if (q3a.value !== 'Jane generates a public/private key pair') q3a.classList.add('wrong');
                if (q3b.value !== 'Jane sends her public key to Tom') q3b.classList.add('wrong');
                if (q3c.value !== 'Tom encrypts the message using Jane\'s public key') q3c.classList.add('wrong');
                if (q3d.value !== 'Tom sends the ciphertext to Jane') q3d.classList.add('wrong');
                if (q3e.value !== 'Jane decrypts the message using her private key') q3e.classList.add('wrong');
            }

            // Q4: Dropdowns
            const q4a = document.getElementById('q4a');
            const q4b = document.getElementById('q4b');
            const q4c = document.getElementById('q4c');
            const q4d = document.getElementById('q4d');
            const q4e = document.getElementById('q4e');
            const q4f = document.getElementById('q4f');

            if (checkSelect(q4a) && checkSelect(q4b) && checkSelect(q4c) && checkSelect(q4d) && checkSelect(q4e) && checkSelect(q4f)) {
                markCorrect('q4');
            } else {
                markWrong('q4');
                allCorrect = false;
            }

            // Q5: Dropdowns
            const q5a = document.getElementById('q5a');
            const q5b = document.getElementById('q5b');
            const q5c = document.getElementById('q5c');
            const q5d = document.getElementById('q5d');

            if (checkSelect(q5a) && checkSelect(q5b) && checkSelect(q5c) && checkSelect(q5d)) {
                markCorrect('q5');
            } else {
                markWrong('q5');
                allCorrect = false;
            }

            // Q6: Drag & Drop
            const bucketTrue = document.getElementById('bucket-true');
            const bucketFalse = document.getElementById('bucket-false');
            let q6Correct = true;

            Array.from(bucketTrue.children).forEach(child => {
                if (child.classList.contains('drag-item')) {
                    if (child.dataset.correct !== 'true') q6Correct = false;
                }
            });
            Array.from(bucketFalse.children).forEach(child => {
                if (child.classList.contains('drag-item')) {
                    if (child.dataset.correct !== 'false') q6Correct = false;
                }
            });
            if (document.getElementById('q6-source').children.length > 0) q6Correct = false;

            if (q6Correct) {
                markCorrect('q6');
                lockDragItems([bucketTrue, bucketFalse]);
            } else {
                markWrong('q6');
                allCorrect = false;
            }

            // Q7: MCQ
            if (q7Selected === 'No need to share secret keys over insecure channels') {
                markCorrect('q7');
                document.querySelectorAll('#q7-options .mcq-option').forEach(opt => { if (opt.dataset.correct === 'true') opt.classList.add('correct'); });
            } else {
                markWrong('q7');
                allCorrect = false;
                document.querySelectorAll('#q7-options .mcq-option.selected').forEach(opt => opt.classList.add('wrong'));
            }

            // Q8: True/False Grid
            let q8Correct = true;
            document.querySelectorAll('#q8-tbody tr').forEach(row => {
                const selected = row.querySelector('input[type="radio"]:checked');
                if (!selected || selected.value !== row.dataset.correct) { q8Correct = false; row.classList.add('wrong-row'); }
                else row.classList.add('correct-row');
            });
            if (q8Correct) markCorrect('q8'); else { markWrong('q8'); allCorrect = false; }

            // Q9: Sortable List
            const q9List = document.getElementById('q9-list');
            const q9Order = Array.from(q9List.children).map(item => parseInt(item.dataset.order));
            if (q9Order.every((val, idx, arr) => idx === 0 || arr[idx - 1] < val) && q9Order.length === 5) {
                markCorrect('q9'); q9List.classList.add('correct');
            } else { markWrong('q9'); q9List.classList.add('wrong'); allCorrect = false; }

            // Q10: Dropdowns
            const q10a = document.getElementById('q10a'), q10b = document.getElementById('q10b');
            const q10c = document.getElementById('q10c'), q10d = document.getElementById('q10d');
            if (checkSelect(q10a) && checkSelect(q10b) && checkSelect(q10c) && checkSelect(q10d)) markCorrect('q10');
            else { markWrong('q10'); allCorrect = false; }

            // Final Completion
            if (allCorrect && !assessmentFinished) {
                assessmentFinished = true;
                clearInterval(timerInterval);
                document.getElementById('btnSubmit').style.display = 'none';
                document.getElementById('btnReturn').style.display = 'inline-block';
                document.getElementById('completionMessage').style.display = 'block';
                document.getElementById('finalScore').textContent = `Attempts: ${totalAttempts} | Time: ${timeTakenStr}`;
                document.getElementById('finalScore').style.display = 'block';
                generatePDF();
            }
        }

        function checkSelect(el) {
            if (el.value === el.dataset.answer) {
                el.classList.add('correct');
                el.classList.remove('wrong');
                return true;
            } else {
                el.classList.add('wrong');
                return false;
            }
        }

        function markCorrect(qId) {
            if (!completed[qId]) {
                completed[qId] = true;
                document.getElementById(`${qId}-status`).textContent = "Correct";
                document.getElementById(`${qId}-status`).className = "q-status correct";
                document.getElementById(`${qId}-block`).style.borderLeftColor = "var(--correct-green)";
            }
        }

        function markWrong(qId) {
            if (!completed[qId]) {
                mistakeCounts[qId]++;
                document.getElementById(`${qId}-status`).textContent = "Incorrect";
                document.getElementById(`${qId}-status`).className = "q-status wrong";
            }
        }

        function lockDragItems(containers) {
            containers.forEach(c => {
                Array.from(c.children).forEach(child => {
                    if (child.classList.contains('drag-item')) {
                        child.draggable = false;
                        child.classList.add('locked');
                    }
                });
            });
        }

        // --- PDF GENERATION ---
        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Page 1: Answers
            doc.setFontSize(20);
            doc.setTextColor(0, 51, 102);
            doc.text(testName, 20, 20);

            doc.setFontSize(12);
            doc.setTextColor(50);
            doc.text(`Teacher: ${teacherName}`, 20, 30);
            doc.text(`Time Taken: ${timeTakenStr}`, 20, 36);
            doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 42);

            let y = 60;
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text("Correct Answers & Justifications", 20, 52);

            doc.setFontSize(10);
            questionMeta.forEach(q => {
                if (y > 270) { doc.addPage(); y = 20; }

                doc.setFont(undefined, 'bold');
                doc.text(`${q.id.toUpperCase()}: ${q.title}`, 20, y);
                y += 5;

                doc.setFont(undefined, 'normal');
                let ansStr = "";
                if (typeof q.correctAnswer === 'object') {
                    ansStr = JSON.stringify(q.correctAnswer).replace(/"/g, '').replace(/,/g, ', ');
                } else {
                    ansStr = q.correctAnswer;
                }

                const splitAns = doc.splitTextToSize(`Answer: ${ansStr}`, 170);
                doc.text(splitAns, 20, y);
                y += (splitAns.length * 5) + 5;
            });

            // Page 2: Feedback
            doc.addPage();
            doc.setFontSize(16);
            doc.text("Feedback & Reflection", 20, 20);

            // Table Header
            let ty = 40;
            doc.setFontSize(10);
            doc.setFillColor(240, 240, 240);
            doc.rect(20, ty - 5, 170, 8, 'F');
            doc.text("Question", 25, ty);
            doc.text("Attempts", 80, ty);
            doc.text("Feedback Code", 130, ty);
            ty += 10;

            // Table Rows
            Object.keys(mistakeCounts).forEach(q => {
                doc.text(q.toUpperCase(), 25, ty);
                doc.text((mistakeCounts[q] + 1).toString(), 85, ty);
                doc.rect(130, ty - 4, 30, 6);
                ty += 10;
            });

            // Key
            ty += 10;
            doc.setFont(undefined, 'bold');
            doc.text("Feedback Codes:", 20, ty);
            ty += 6;
            doc.setFont(undefined, 'normal');
            doc.text("C: Content gap", 20, ty); ty += 5;
            doc.text("E: Exam technique", 20, ty); ty += 5;
            doc.text("L: Language/clarity", 20, ty); ty += 5;
            doc.text("T: Time/effort", 20, ty); ty += 5;
            doc.text("M: Misread/misapplied", 20, ty);

            // Reflection Boxes
            ty += 15;
            doc.setDrawColor(40, 167, 69); // Green
            doc.setLineWidth(1);
            doc.rect(20, ty, 170, 40);
            doc.setTextColor(40, 167, 69);
            doc.text("Student Reflection:", 25, ty + 8);

            ty += 50;
            doc.setDrawColor(111, 66, 193); // Purple
            doc.rect(20, ty, 170, 40);
            doc.setTextColor(111, 66, 193);
            doc.text("Teacher Comment:", 25, ty + 8);

            doc.save(`${testName.replace(/ /g, '_')}_Feedback.pdf`);
        }
    </script>
</body>

</html>